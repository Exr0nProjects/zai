Notes from LLM agents:

## Project Overview
(agent:contenteditable-basics) zai is a collaborative timeline-based notes app built with SvelteKit, TipTap editor, and Y.js CRDT. Features Supabase authentication, real-time collaboration, and offline persistence with a clean, distraction-free writing experience.

## Architecture Decisions
(agent:contenteditable-basics) **Framework**: SvelteKit chosen for modern development experience and excellent integration with TipTap
(agent:contenteditable-basics) **Editor**: TipTap with StarterKit, TaskList, TaskItem, Collaboration extensions for rich collaborative editing
(agent:contenteditable-basics) **Authentication**: Supabase Auth with SMS/phone verification for secure user access
(agent:contenteditable-basics) **Real-time Collaboration**: Y.js CRDT with custom Supabase provider for serverless conflict-free editing
(agent:contenteditable-basics) **Storage**: IndexedDB (y-indexeddb) for offline persistence + Supabase database for cloud sync
(agent:contenteditable-basics) **Serverless Architecture**: 100% serverless using Supabase database + Realtime for collaboration
(agent:contenteditable-basics) **State Management**: Y.js document state with Svelte auth stores
(agent:contenteditable-basics) **Styling**: TailwindCSS for clean, minimal UI with Lora font for elegant typography

## Current Implementation Status
(agent:contenteditable-basics) ✅ Basic SvelteKit app with simplified structure (removed auth/backend complexity)
(agent:contenteditable-basics) ✅ TipTap editor with bullet lists, todo lists, and timeline functionality
(agent:contenteditable-basics) ✅ Custom Timeline mark extension for "Now" indicators
(agent:contenteditable-basics) ✅ Auto-save to localStorage on content changes
(agent:contenteditable-basics) ✅ Timeline navigation with "Jump to Now" button that scrolls timeline marker to center
(agent:contenteditable-basics) ✅ Basic search functionality within editor content
(agent:contenteditable-basics) ✅ Clean toolbar with easy access to bullet lists, todo lists, and timeline insertion
(agent:contenteditable-basics) ✅ Responsive bottom bar with search and timeline navigation
(agent:hidden-blocks) ✅ **Hidden Blocks System**: TipTap extension that can hide any block type with zero height, no interaction, and proper keyboard navigation skipping
(agent:timestamp) ✅ **Block-level Timestamps**: Extended Paragraph, BulletList, TaskList, ListItem, TaskItem nodes with blockId, createdAt, parentId attributes
(agent:timestamp) ✅ **Snowflake ID Generator**: 64-bit unique IDs with timestamp, user, hour, and sequence components for reliable block identification
(agent:timestamp) ✅ **Split Behavior**: When nodes are split (Enter key), new blocks get fresh IDs and timestamps with parent tracking
(agent:timestamp) ✅ **Block Sorting Utilities**: Functions to extract, sort, and analyze timestamped blocks for timeline-based organization
(agent:timestamp) ✅ **Debug Interface**: Block debug panel showing stats, hierarchy, and time ranges for development
(agent:timestamp) ✅ **Block Decorations**: Hover tooltips in left gutter showing block IDs, timestamps, and parent relationships  
(agent:timestamp) ✅ **Visual Controls**: CSS variables for toggling debug borders and block borders independently
(agent:feat:links) ✅ **Link Support**: Full link mark implementation with TipTap Link extension for clickable hyperlinks
(agent:feat:links) ✅ **Link Bubble Menu**: Contextual menu that appears when cursor is inside a link with edit, remove, and open actions
(agent:feat:links) ✅ **Link Dialog**: Modal interface for adding and editing links with URL input, keyboard shortcuts (Enter/Escape)
(agent:feat:links) ✅ **Smart Link Behavior**: Handles both selected text linking and standalone URL insertion, click selection enabled
(agent:feat:tags) ✅ **Tag System**: TipTap mention extension configured for hashtags with # trigger, web worker for tag extraction, and real-time tag suggestions
(agent:feat:tags) ✅ **Tag Keyboard Navigation**: Fixed Enter key priority issue where default newline handler was intercepting tag selection - used TipTap's extend() method with addKeyboardShortcuts() to override priority, working with the ecosystem rather than against it

## Features
(agent:contenteditable-basics) **Timeline-based writing**: Insert timeline markers to organize content by time
(agent:contenteditable-basics) **Jump to Now**: Quick navigation to scroll timeline marker to center of screen
(agent:contenteditable-basics) **Rich formatting**: Bullet lists, numbered lists, and interactive todo lists
(agent:contenteditable-basics) **Auto-save**: Content automatically saved to localStorage on changes
(agent:contenteditable-basics) **Search**: Basic text search within editor content
(agent:timestamp) **Block Timestamps**: Every paragraph, list item, and list has unique IDs, creation timestamps, and parent relationships
(agent:timestamp) **Timestamp Sorting**: Blocks can be sorted chronologically with debug tools for viewing block hierarchy
(agent:feat:links) **Hyperlink Support**: Create and edit links with accent color styling, hover underlines, and right-click editing
(agent:feat:links) **Link Navigation**: Click to open links, cursor navigation with arrow keys, contextual bubble menu for editing
(agent:feat:tags) **Tag Mentions**: Type # to trigger tag suggestions, web worker automatically extracts and indexes hashtags from document content, visual loading indicator during processing

## Development Commands
(agent:contenteditable-basics) Install dependencies: `bun install`
(agent:contenteditable-basics) Run development server: `bun run dev`
(agent:contenteditable-basics) Build for production: `bun run build`

## Environment Setup Required
(agent:contenteditable-basics) **Step 1**: Create `.env` file with: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY
(agent:contenteditable-basics) **Step 2**: In Supabase Dashboard > Authentication > Providers > Enable "Phone" and configure Twilio
(agent:contenteditable-basics) **Step 3**: Run `supabase-schema.sql` in your Supabase SQL editor to create the documents table
(agent:contenteditable-basics) **Step 4**: Enable Realtime for the documents table in Supabase Dashboard

## Technical Notes
(agent:contenteditable-basics) **Editor Extensions**: StarterKit (no history), TaskList/TaskItem (todos), Collaboration, Placeholder, custom TimelineMark
**TipTap Extension Pattern**: TipTap extensions should use global variables and exported functions for shared state, NOT closures. Closures don't work properly with TipTap's extension system. See SearchHighlightPlugin.js and HiddenBlocksPlugin.js for correct patterns: declare global variables outside the extension, use exported functions to interact with them, and reference globals directly in plugin logic.
(agent:contenteditable-basics) **Timeline Implementation**: Custom mark extension that renders "Now" indicator with blue line styling
(agent:contenteditable-basics) **Y.js CRDT Backend**: Real-time collaborative document state with conflict resolution
(agent:contenteditable-basics) **Custom Supabase Provider**: Y.js provider that syncs with Supabase database + Realtime for serverless collaboration
(agent:contenteditable-basics) **IndexedDB Persistence**: Local offline storage with automatic Y.Doc sync via y-indexeddb
(agent:contenteditable-basics) **Timeline Navigation**: Finds timeline marks in document and scrolls them to viewport center
(agent:contenteditable-basics) **Document State**: Y.Doc + IndexedDB + Supabase database manages all content, fully serverless
(agent:timestamp) **Extended Node Architecture**: Custom TipTap extensions that extend base nodes (Paragraph, BulletList, etc.) with blockId, createdAt, parentId attributes
(agent:snowflake-epoch) **Snowflake IDs**: Simple function generating 64-bit IDs with 32-bit Linux epoch timestamp (seconds) + 32-bit random data, using BigInt for full JavaScript precision and collision-free identification, replaced class-based approach with single generateBlockId() function. Fixed critical bug where processSubtree was called with array instead of individual nodes, causing "Cannot read properties of undefined (reading 'blockId')" crash in search system. Added debugging for duplicate blockId detection during document traversal. Implemented prefers-color-scheme: dark mode with CSS media queries targeting editor, inputs, buttons, and Tailwind utility classes for complete dark theme support. Added debug new blocks feature: when enabled via window.toggleDebugNewBlocks() or UI toggle, new blocks get blue solid borders with "NEW" label, parent blocks get blue dashed borders with "PARENT" label - helps visualize TimestampPlugin block creation in real-time. **MAJOR REFACTOR**: Consolidated all 10+ individual Extended* node files into single self-contained extendedNodes.js file - reduced code duplication from ~400 lines across 11 files to ~115 lines in 1 file while maintaining identical functionality. All block attributes, helper functions, and node extensions now live in one cohesive place. Added conditional scroll behavior - focusAtEnd() only triggers on document load if the document contains meaningful content (non-empty text or timeline marks), preventing unnecessary scroll animation on empty documents. Added auto-focus to phone input on login page load for better user experience.
(agent:timestamp) **Block Splitting Logic**: Custom Enter key handlers that preserve parent-child relationships when splitting nodes
(agent:timestamp) **Block Sorting System**: Utilities for extracting, sorting, and analyzing blocks by creation timestamp for timeline views
(agent:feat:links) **Link Extension**: TipTap Link extension with openOnClick disabled, click selection enabled, accent color styling
(agent:feat:links) **BubbleMenu Integration**: Contextual floating menu using @tiptap/extension-bubble-menu that appears when cursor is in link
(agent:feat:links) **Link State Management**: Modal dialog with proper keyboard handling, URL validation, and state cleanup
(agent:feat:links) **Smart Link Detection**: Automatic protocol handling, link updating vs creation based on selection and context
(agent:feat:tags) **Tag System Architecture**: Web worker-based tag extraction using regex pattern `/(?:^|\s)#([^\s#]+)/g`, TipTap mention extension with tippy.js suggestions, debounced content processing (2s delay), reactive Svelte stores for tag state management
(agent:feat:tags) **Tag Navigation Priority Fix**: Critical lesson learned about TipTap keyboard priority - default Enter handler (newline creation) has higher priority than suggestion system. Fixed by extending Mention extension with addKeyboardShortcuts() that detects active suggestion state and returns false to let TipTap's suggestion utility handle Enter selection. Tab works as Enter alias, Ctrl+N/P for vim navigation, all arrow keys handled by TipTap natively.
(agent:hidden-blocks) **Hidden Blocks Plugin**: TipTap extension using addGlobalAttributes() to add 'hidden' attribute to all block types (paragraph, heading, lists, etc.), ProseMirror decorations for styling, keyboard shortcuts to skip hidden blocks during navigation, click/selection prevention, and deletion protection. Commands: hideBlock(), showBlock(), toggleBlockVisibility(), hideAllBlocks(), showAllBlocks().

## Current Serverless Integration
(agent:contenteditable-basics) ✅ **Supabase Authentication**: SMS/phone verification with secure JWT tokens and session management
(agent:contenteditable-basics) ✅ **Auth-protected Routes**: Login page with automatic navigation guards and user state management
(agent:contenteditable-basics) ✅ **Y.js CRDT collaboration**: Integrated @tiptap/extension-collaboration with yjs for real-time editing
(agent:contenteditable-basics) ✅ **Conflict-free document state**: Y.Doc manages all document state with IndexedDB + Supabase sync
(agent:contenteditable-basics) ✅ **Collaborative history**: Disabled StarterKit history in favor of Y.js collaborative undo/redo
(agent:contenteditable-basics) ✅ **Smart initial content**: Content loaded once per document using Y.js config map
(agent:contenteditable-basics) ✅ **IndexedDB persistence**: Offline storage with y-indexeddb for local data persistence
(agent:contenteditable-basics) ✅ **Serverless real-time sync**: Custom SupabaseProvider using database + Realtime for collaboration
(agent:contenteditable-basics) ✅ **User-specific documents**: RLS policies ensure users only access their own documents
(agent:contenteditable-basics) ✅ **100% Serverless Architecture**: No servers to maintain, scales automatically with Supabase
(agent:contenteditable-basics) ✅ **Proper cleanup**: All providers and Y.js document destroyed on component unmount

## PWA Implementation
(agent:contenteditable-basics) ✅ **Progressive Web App**: Full PWA setup with @vite-pwa/sveltekit for offline capability and installability
(agent:contenteditable-basics) ✅ **Service Worker**: Custom Workbox-based service worker with intelligent caching strategies
(agent:contenteditable-basics) ✅ **Web App Manifest**: Complete manifest.json with app metadata, icons, and installation settings
(agent:contenteditable-basics) ✅ **Offline Support**: Network-first strategy for API calls, cache-first for static assets, works fully offline with IndexedDB
(agent:contenteditable-basics) ✅ **Auto-Updates**: Service worker update notifications with user-friendly update banner
(agent:contenteditable-basics) ✅ **Font Caching**: Smart caching of Google Fonts for offline typography
(agent:contenteditable-basics) ✅ **Mobile-Optimized**: Apple PWA meta tags and mobile-specific configurations

## Search System
(agent:search) **Redesigned Search Architecture**: Completely redesigned with simpler, more reliable approach - for any query, determines desired visibility state for ALL blocks and sets each block to that state
(agent:search) **Real-time & Case Insensitive**: Search triggers immediately on typing with full case insensitive matching (both query and content converted to lowercase)
(agent:search) **Word Matching**: Space-separated search terms require ALL words to be present in block content (order doesn't matter)
(agent:search) **Bidirectional Processing**: Processes blocks starting from present time working backwards/forwards, prioritizing recent content
(agent:search) **No Flashing**: TipTap's hidden blocks system only changes DOM for blocks that actually need state changes, eliminating visual flashing
(agent:search) **Expanding Query Support**: When deleting characters (making query broader), previously hidden blocks that now match become visible again
(agent:search) **Stream Processing**: Processes blocks in chunks with yield points to avoid blocking UI during large document search
(agent:search) **Clean State Management**: Simple approach eliminates complex state tracking - just determines what each block's visibility should be and sets it
(agent:search) **Extended Block Coverage**: Fixed missing .hidden-block class issue by creating ExtendedOrderedList, ExtendedBlockquote, ExtendedCodeBlock, and ExtendedHorizontalRule extensions - all block types in HiddenBlocksPlugin now have blockId attributes and can be properly hidden during search
(agent:search) **Hierarchical Hiding Logic**: Enhanced hideBlock/showBlock commands to handle parent-child relationships - when hiding a paragraph inside a list item, the list item is also marked as hidden if all its content becomes hidden, ensuring proper CSS styling and visual separators work correctly
(agent:search) **Smart Center Block Tracking**: Enhanced center block selection to avoid hidden elements, with scroll event handling that automatically recomputes the center block when user scrolls during active search, maintaining spatial reference throughout search sessions
(agent:search) **Hierarchical Hiding Bug Fixes**: Fixed critical issue where list items and bullet lists weren't getting hidden-block class - enhanced hierarchical hiding logic to check direct children only (not all descendants) and added proper debugging logs to track parent node hiding behavior
(agent:hidden-dividers) **Enhanced Debugging for Hidden Block Issues**: Added comprehensive logging to HiddenBlocksPlugin hideBlock command showing block content (not just IDs), parent-child relationship analysis, and specific visibility blockers - logs show exactly which visible children prevent parent nodes from being hidden, helping debug why .hidden-block class isn't applied to container elements like ul/li during search
(agent:hidden-dividers) **Critical Transaction State Bug Fix**: Fixed hierarchical hiding logic by tracking blocks hidden in current transaction (hiddenInThisTransaction Set) - the bug was that parent-child analysis checked original document state (child.attrs.hidden) instead of transaction state, so even after marking children as hidden, parent nodes couldn't see the updated state and remained unhidden, preventing .hidden-block CSS class application
(agent:hidden-dividers) **Complete Architecture Simplification**: Removed all permanent hiding complexity and transaction-based hiding system - replaced with clean search state store (searchHiddenBlocks) that manages temporary UI state only. HiddenBlocksPlugin now only handles keyboard navigation and interaction prevention, checking the Svelte store instead of document attributes. Search operations use store functions (hideBlockInSearch/showBlockInSearch/clearSearchHiding) instead of ProseMirror commands. Decorations applied based on store state, eliminating undo/redo pollution and collaboration interference. Added editor reference management to force decoration updates when store changes. Removed all manual hiding debug functionality to focus solely on search-based hiding.
(agent:search-correctness) **Simplified Recursive Search**: Removed complex hierarchy building and replaced with direct TipTap document traversal using native ProseMirror structure. Algorithm: 1) Recursively process each node in document order, 2) For nodes with blockId, check content using serializeToMarkdown, 3) Check if node or any descendants match query, 4) Show/hide based on subtree matches, 5) Recurse into children with correct position calculation. Fixed critical "Index out of range" bug by properly calculating child positions using childPos += child.nodeSize instead of incorrect index multiplication. Eliminated duplicate processing, visited maps, and cycle detection while maintaining the conceptually correct recursive approach.
(agent:search-correctness) **Enhanced Hidden Block CSS**: Implemented clean visual system for hidden blocks: 1) `.hidden-block` completely hides blocks with `display: none` preventing selection and interaction, 2) CSS selectors `.hidden-block:first-child` and `:not(.hidden-block) + .hidden-block` detect first hidden block in each contiguous sequence, 3) Shows dotted double horizontal line indicator using `repeating-linear-gradient` positioned with `::before` pseudoelement, 4) Indicators remain visible even when parent blocks are hidden via absolute positioning, 5) Dark mode support with appropriate colors. Each section of hidden blocks shows exactly one visual indicator regardless of how many blocks are hidden.
(agent:search-correctness) **Parent Visibility & Search Highlighting**: Enhanced search with two major improvements: 1) **Parent Visibility Logic** - Implemented two-pass algorithm where first pass identifies matching nodes and marks all ancestors for visibility using `markAncestorsForVisibility()` that walks up document tree via `$pos.node(depth)`, ensuring parent containers of matching children are always shown, 2) **Search Match Highlighting** - Created SearchHighlightPlugin using TipTap/ProseMirror decorations with `Decoration.inline()` for text ranges, finds exact character positions using `findTextMatches()` with case-insensitive matching and overlap merging, highlights with blue rounded background via CSS `.search-highlight` class, coordinates with StreamingSearch via `setSearchHighlight()/clearSearchHighlight()` functions, supports both light/dark modes and hides highlights on hidden blocks. Matches are highlighted in real-time as user types.
(agent:search-correctness) **Consistent Accent Color System**: Established CSS variables `--accent-light: #3b82f6` and `--accent-dark: #2563eb` for unified theming across the app. Updated all hardcoded accent colors to use these variables. Search highlights now use consistent accent color with 20% opacity (`rgba(59, 130, 246, 0.2)` in light mode, `rgba(37, 99, 235, 0.2)` in dark mode) for subtle but visible highlighting that preserves text readability with `color: inherit`. Used `rgba()` instead of `color-mix()` for broader browser compatibility. All debug styles, timeline markers, and other accent-colored elements now use the same color system.
(agent:search-correctness) **Enhanced List Context in Search**: Added intelligent list context visibility - when marking ancestors for search visibility, if an ancestor is a list node (bulletList, orderedList, or taskList), the system also marks the list's previous sibling for visibility using `findPreviousSibling()`. This uses ProseMirror's position resolution (`$pos.index(depth - 1)` and `parent.child(indexInParent - 1)`) to locate sibling nodes. Provides better search context by showing introductory paragraphs or headings that precede matching lists, making search results more meaningful and providing necessary context for understanding list items.
(agent:search-correctness) **Fixed Search Scrolling Regression**: Restored smooth scrolling behavior during search by adding `scrollToKeepBlockCentered(this.centerBlockId)` call after search completion. The regression occurred because scrolling was only happening during search initialization and clear, but not after each search update as user types. Now maintains center block position consistently throughout typing, providing stable visual reference point during search filtering.
(agent:search-correctness) **Empty Search Placeholder**: Added friendly empty search message "nothin. search again?" that appears when user has typed a search query but no matches are found. Uses reactive variable `isSearchEmpty` that tracks when `searchQuery.trim().length > 0 && searchProgress.completed && searchProgress.matched === 0`. Positioned 4rem below the editor (where hidden block dashed lines would appear) using Arial font. Includes proper dark mode support with gray-500 in light mode and gray-400 in dark mode. Provides better UX feedback for unsuccessful searches instead of leaving users with a blank screen.
(agent:search-correctness) **UI Cleanup & Barlow Font**: Updated empty search placeholder to use Barlow font and added negative margins (-2rem left/right) to align with hidden block indicators despite editor padding. Removed all debug controls from UI - debug button, debug panel, and debug checkboxes are gone. Debug flags are now code-only constants at top of file (`const debugNewBlocks = false`). Cleaned up unused blockStats tracking and showBlockDebug variables. Simplified editor update handlers to only handle tag extraction and title updates. Debug functionality still available through code flags but no longer clutters the UI.

## Next Steps
(agent:contenteditable-basics) Implement awareness for cursor positions and user presence indicators
(agent:contenteditable-basics) Add document sharing and collaborative permissions system
(agent:contenteditable-basics) Optimize debouncing and sync strategies for better performance
(agent:contenteditable-basics) Timeline positioning system in place for advanced time-based navigation features
(agent:timestamp) Build chronological document views and timeline-based navigation using the new block timestamp system
(agent:timestamp) Add block reordering capabilities based on timestamps for temporal document organization
(agent:search) Add search highlighting to visually indicate matching terms within visible blocks
(agent:search) Implement search history and recent searches for improved user experience

## TODO: System Interaction Monitoring
(agent:feat:tags) **Performance Risk - Collaboration**: Tag extraction runs on EVERY editor update including collaborative changes - consider adding collaboration-aware filtering to only process local changes using `!transaction.getMeta('y-sync$')` check
(agent:feat:tags) **Accessibility Risk - Tab Navigation**: KeyboardNavigationPlugin removes tabindex from checkboxes - monitor impact on keyboard users who need to navigate todo lists, may need more granular control
(agent:feat:tags) **Memory Risk - Web Worker Cleanup**: Multiple async systems (tag worker, debounced extraction, collaborative sync) need careful monitoring for memory leaks during heavy collaborative sessions  
(agent:feat:tags) **Keyboard Priority Stack**: Monitor interaction between multiple keyboard handlers (Tags: Enter priority override, Links: Cmd+K, Lists: Tab/Shift+Tab, Tasks: built-in) - should work harmoniously but worth testing edge cases
(agent:feat:tags) **Performance Optimization**: Consider tracking tag processing time for large documents and implementing performance monitoring, especially for documents with hundreds of hashtags
(agent:serialize-marks) **Fixed Serialization Issue**: Tag mentions (hashtag nodes) and links were disappearing when saved to Supabase because MarkdownClipboard serialization didn't handle mention nodes - added proper mention node serialization in processTextContent function and hashtag parsing in MarkdownPaste parseInlineMarkdown function for complete round-trip support
(agent:three-block-sep) **Visual Block Separators**: Added CSS rule to insert horizontal line after 2nd empty paragraph in sequences of 2+ empty paragraphs - targets both mid-document sequences (non-empty + empty + empty) and document-start sequences (first-child empty + empty), uses 3rem padding and scroll-to-now button positions content at 1/3 viewport height, ensures only one line per sequence regardless of length
(agent:pill-login-pin) **UI Refinements**: Updated login flow to use pill design for both phone and OTP steps, replaced "i" in "zai" branding with pin icon for visual consistency, switched all typography from Lora/Interface to Barlow font family, updated indent/outdent icons to clean double chevrons (>> and <<), improved login form usability with consistent pill styling, created custom favicon using pin icon with accent color (#2563eb), implemented dynamic document title "zai - {{first non-empty line}}" that updates based on current section context as user types/moves cursor
(agent:root-only-title) **Title Logic Refinement**: Modified findCurrentSectionFirstLine function to strictly require 2+ empty root-level lines above current section before showing dynamic title - prevents title from appearing in document start or sections without proper separator, ensures only valid sections (separated by double empty lines) contribute to window title
(agent:efficient-title) **Performance & Maintainability Fix**: Exported serializeToMarkdown from MarkdownClipboard.js to eliminate duplicate broken serializer in +page.svelte, rewrote findCurrentSectionFirstLine to be O(log N) by starting from cursor position and working backwards instead of processing all blocks, now uses proper markdown serializer ensuring tags and formatting appear correctly in document titles
(agent:ignore-cursor-empty) **Title Logic Edge Case Fix**: Modified section detection to ignore empty line at cursor position when counting separator lines - if cursor is on empty line, start backwards search from line above it, prevents current typing position from interfering with section boundary detection logic
(agent:zai-logo-pills) **Component Creation & UI Consistency**: Created reusable ZaiLogo.svelte component with invisible "i" and correctly positioned pin icon, supporting sm/md/lg sizes and custom colors. Updated all top chips (version tag, debug, tag processing) to use consistent pill styling with rounded-full borders and proper spacing. Replaced hardcoded zai logos in both main page and login page with the new component for maintainability
(agent:cmd-f-search-shortcut) **Added Cmd+F Search Keyboard Shortcut**: Created SearchKeyboard TipTap extension using addKeyboardShortcuts() to bind 'Mod-f' (Cmd+F on Mac, Ctrl+F on Windows/Linux) to search functionality. Added focusSearchInput() function that handles both desktop and mobile UI - on mobile expands search first if collapsed then focuses input, on desktop directly focuses the search input. Uses responsive design detection (window.innerWidth < 768) to determine mobile vs desktop behavior. Extension added to editor alongside CustomLink extension. User also cleaned up logging by adding LOG = false flag to silence debug output in TimestampPlugin and commented out the oldBlockId fallback parentId logic.
(agent:search-correctness) **Mobile Touch Target Improvements**: Enhanced mobile usability by increasing touch targets for editing tool buttons (indent, outdent, todo list, link) in the bottom toolbar. Changed responsive padding from `py-2` (8px) to `py-3 md:py-2` (12px on mobile, 8px on desktop) to match the height of search and jump-to-end buttons. This provides consistent 48px minimum touch targets on mobile devices as recommended by accessibility guidelines while maintaining compact desktop layout. Uses mobile-first responsive design with Tailwind CSS to ensure proper touch ergonomics across all screen sizes.
(agent:inline-parsing) **Inline Pattern Parsing System**: Built comprehensive real-time pattern detection using TipTap's onUpdate event for dates, tags, and relative time phrases. Extension detects date keywords (days: m/mon/monday, months: jan/january), numerical dates (6/7, 12/25/2024), relative phrases (tonight, tomorrow morning, tmr), and inline tags (#hashtag). Implements "seed + extension" logic where patterns like "6 jun" trigger extended date detection. Uses custom marks for visual styling with distinct colors per pattern type (green for date keywords, blue for numerical dates, purple for relative phrases, orange for extended dates, accent color for tags). Includes hover effects, dark mode support, and debug controls (window.toggleInlineParser(), window.clearInlineParsing()). **Critical Fix**: Replaced buggy InputRule approach with onUpdate event listener + debounced pattern analysis + direct ProseMirror mark application, eliminating "find is not a function" error. **Robustness Fix**: Added proper error handling for mark schema checking and rangeHasMark calls to prevent "Cannot read properties of undefined (reading 'isInSet')" errors. **Enhanced Relative Patterns**: Expanded from 7 to 100+ relative time combinations including flexible patterns like "tmr morning", "today 3p", "midnight", time numbers (1a-12p), and period variations (morn, aft, eve). **Chip Conversion System**: Added hybrid marks-to-chips architecture following TipTap ecosystem patterns - marks provide real-time preview highlighting while typing, InputRules convert completed patterns to proper chip nodes when user types space. Creates DateChip and TagChip nodes that are non-editable, selectable atoms with hover effects and proper styling. Follows same pattern as existing TagMention system. Uses 300ms debounce, mark collision detection, and focused processing of current text block only. Fully integrated with existing editor ecosystem alongside tag mentions and search systems. **Final Simplification**: Removed chip complexity entirely at user request - now uses marks-only approach for simplicity and performance, treating patterns as transient highlights recomputed per block on completion characters. **Timeline Integration**: Added `timelineTime` attribute to all extended nodes, integrated chrono-node for robust date parsing with local timezone support, created time gutter system with smart relative formatting (10:55 for today, "3 days ago", "2.3 weeks ago" based on 4am cutoff logic), implemented ProseMirror decoration-based time gutter display with Barlow light typography. **BlockId Traversal Fix**: Modified timelineTime attribute application to traverse upwards until finding a block with blockId attribute (for proper list item targeting) rather than applying to immediate containing block, ensuring time gutters appear at appropriate structural levels like list items instead of nested paragraphs.
(agent:timeline-queue) **Timeline Sorting Queue System**: Refactored TimelineSortingPlugin to use global queue pattern instead of closures. The plugin now maintains a global `sortQueue` Set of block IDs that need sorting, with exported functions `addBlockToSortQueue()`, `clearSortQueue()`, and `getSortQueueSize()`. Only sorts blocks when: 1) cursor is not currently inside the block (`isCursorInBlock()`), 2) block is leaf-level with no children that have blockId attributes (`isLeafBlock()`), 3) block has a valid `timelineTime` attribute. The queue processes one block at a time in the view update cycle to avoid overwhelming the editor. Tracks both cursor movement and transaction-modified blocks for comprehensive sorting coverage.
(agent:tooltip-fix) **Fixed Tooltip Timestamp Display**: Fixed BlockInfoDecorator tooltip showing year 1269 bug by properly handling both ISO string and timestamp formats for createdAt attribute. Now displays both timelineTime and createdAt in raw timestamp format (e.g. "Dec 25, 3:45 PM") instead of relative time. Enhanced tooltip to show timeline information when available, providing clearer timestamp debugging information for block attributes.
(agent:infinite-loop-fix) **Prevented Paragraph Duplication Bug**: Fixed TimestampPlugin infinite loop that was creating many new paragraphs on load. Added transaction skip conditions to prevent processing our own timestamp transactions (zai-idRelabel meta) and Y.js collaboration transactions (y-sync$ meta). This stops the cascade where TimestampPlugin would process its own setNodeMarkup operations, creating an endless cycle of new transactions during initialization.
(agent:smart-sorting) **Smart Timeline Sorting Optimization**: Enhanced TimelineSortingPlugin to avoid unnecessary block movement when target position has same timestamp. Added cursor-based queue addition (blocks get queued when cursor enters them) and initial load sorting (all existing blocks queued on plugin initialization). Prevents thrashing between consecutive blocks with identical timestamps by comparing target position timestamp before moving.
(agent:custom-lists) **Custom List Item System**: Created advanced CustomListItem node as alternative to nested TipTap lists. Each list item is a top-level block with indentation levels (0-5), supporting both bullet and checkbox types. Features Tab/Shift-Tab for indent/outdent, Enter for new items, Backspace for outdenting. Includes global node registry system to maintain parent-child relationships in children arrays (reverse pointers to parentId). TimestampPlugin updated to handle customListItem nodes and maintain bidirectional parent-child relationships. Added toolbar buttons for creating custom bullet and todo lists with responsive styling and dark mode support.
(agent:backend-replacement) **Backend List Replacement**: Completely replaced old TipTap list extensions (ExtendedBulletList, ExtendedTaskList, etc.) with CustomListItem system. Added automatic markdown detection - typing "  - " creates bullet lists, "  - [ ] " creates todo lists (2 spaces = 1 indent level). Enhanced with full markdown serialization/deserialization support including three checkbox states (todo, done [ ], dropped [~]). Updated Todo List button to preserve current indent level instead of resetting to 0. Removed all old list types from editor extensions and TimestampPlugin processing. Added children attribute to common ExtendedNodes interface for all block types.
(agent:list-fixes) **Custom List System Bug Fixes**: Fixed critical TypeError "updateParentChildRelationships is not a function" by removing duplicate parent-child management (TimestampPlugin already handles this). Fixed parseHTML to properly match 'li' elements instead of 'div'. Fixed all command implementations (toggleCustomListType, toggleCheckbox, setCheckboxState, getCurrentIndentLevel) to properly find customListItem parent nodes using position resolution instead of incorrect nodeAt() calls. Fixed Enter key behavior to traverse parent nodes correctly. Added flexible markdown support for spacing variations: supports "- []", "-[]", "- [ ]", "-[ ]", etc. Updated checkbox syntax to use [-] for dropped state instead of [~]. Fixed content structure in MarkdownPaste to use inline content directly instead of wrapping in paragraphs.
(agent:final-fixes) **Final List System Completion**: Fixed "getMaxIndentLevel is not a function" error by moving helper functions outside node definition following TipTap patterns. Implemented toggle behavior for Todo List button - now toggles between enabling custom list items and converting back to paragraphs. Added proper checkbox click handling using addDOMEventListeners() for direct interaction. Simplified renderHTML structure by removing unnecessary label wrapper and inline styles, letting CSS handle all styling. Added margin-right to checkbox CSS for proper spacing. System now fully functional with markdown detection, toggle UI, clickable checkboxes, and consistent styling matching original HTML structure.
(agent:navigation-fixes) **Navigation & Keyboard Behavior Fixes**: Fixed Tab/Shift-Tab keyboard shortcuts to only apply when inside customListItem (preventing interference with save button tabindex). Replaced updateAttributes with direct transaction manipulation using tr.setNodeMarkup to eliminate RangeError issues when indent level > 2. Fixed Backspace behavior to convert to paragraph when at top level (indent 0) instead of deleting entire list item. Updated input rules to require space after dash (now "- " creates bullet, not just "-"). Changed bullet character from • to - for better visual consistency. Removed problematic indentListItem/outdentListItem commands in favor of direct transaction handling. Arrow keys and normal navigation now work properly without interference.
(agent:delete-children-arr) **Children Array Deletion Handling**: Enhanced TimestampPlugin to automatically update parent children arrays when nodes are deleted. Added deletion detection by comparing blockIds between oldState and newState, then removing deleted blockIds from their parent's children array. Uses existing plugin architecture instead of creating separate deletion handler. Also ensured children attribute is available in both conditional and standard block attribute functions for consistent interface across all extended nodes. **Transaction Position Bug Fix**: Fixed critical bug in TimestampPlugin where parent-child updates were using `newState.doc` instead of `tr.doc` after nodes were already modified, causing position conflicts and malformed transactions. Changed to use `tr.doc.descendants()` for consistent transaction state. **CustomListItem Indent Logic Fix**: Fixed `getMaxIndentLevel()` function which was incorrectly looking for structural parents in ProseMirror tree instead of using `parentId` attribute relationships. Now properly traverses document to find parent by blockId and calculates correct maximum indent level. Changed fallback from 5 to 1 for better UX when no parent exists. **Keyboard Behavior Improvements**: Fixed Tab key to always preventDefault even when at maximum indent level to prevent unwanted tab navigation. Enhanced Enter key behavior on empty list items to unindent (like Backspace) instead of creating new items. Fixed Todo List button to preserve current indent level by looking at previous sibling list items instead of always starting at level 0. **Final List Behavior Fixes**: Restricted indentation to only work when parent is actually a customListItem (returns 0 if parent isn't a list item), preventing invalid nesting. Fixed Todo List button to properly toggle between bullet and checkbox listType instead of incorrectly converting to paragraph, preserving indent level and resetting checkbox state. **Click Detection & Navigation Debugging**: Added comprehensive logging to checkbox click handler to debug interaction issues. Enhanced click detection to handle both direct checkbox clicks and list item clicks. Added ArrowUp/ArrowDown/Ctrl-n keyboard shortcuts to fix navigation getting trapped in list item labels - now properly jumps between blocks at appropriate positions.

